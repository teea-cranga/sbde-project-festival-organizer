DROP TABLE TERENURI CASCADE CONSTRAINTS;
DROP TABLE CONSTRUCTII CASCADE CONSTRAINTS;
DROP TABLE INFO_CONSTRUCTII CASCADE CONSTRAINTS;

-- CREARE TABELE
CREATE TABLE TERENURI(
ID_TEREN NUMBER CONSTRAINT PK_TID PRIMARY KEY,
TIP_TEREN VARCHAR2(9) CONSTRAINT CK_TTIP CHECK (TIP_TEREN IN('ASFALT','IARBA','PIETRIS','INTRARE')), --MANDATORY CONCRETE, GRASS, GRAVEL
NUME_TEREN VARCHAR2(50) CONSTRAINT NN_NUMET NOT NULL, --POATE SA FIE CAMPING, PARCARE, SAU PERIMETRUL FESTIVALULUI (IMPARTIT IN ZONE IN FUNCTIE DE TIPUL DE TEREN)
FORMA_TEREN SDO_GEOMETRY
);

CREATE TABLE CONSTRUCTII(
ID_CONSTRUCTIE NUMBER CONSTRAINT PK_CONST PRIMARY KEY,
COD_CONSTRUCTIE NUMBER CONSTRAINT NN_CODC NOT NULL, -- COD INFORMATIV PENTRU MAP VIEW
FORMA_CONSTRUCTIE SDO_GEOMETRY,
ID_TEREN NUMBER REFERENCES TERENURI(ID_TEREN)
);

CREATE TABLE INFO_CONSTRUCTII(
ID_CONSTRUCTIE NUMBER REFERENCES CONSTRUCTII(ID_CONSTRUCTIE),
TIP_CONSTRUCTIE VARCHAR2(100) CONSTRAINT CK_CTIP CHECK(TIP_CONSTRUCTIE IN('TOALETA','CORT MANCARE','CORT MERCH','SCENA', 'BAR','PRIM AJUTOR', 'BIROU INFORMATII','ZONA MESE')), 
-- BIROU INFORMATII (COD 1), CORT MANCARE (COD 2), BARURI (COD 3), PRIM AJUTOR (COD 4), CORT MERCH (COD 5), TOALETE (COD 6),MESE (COD 7), SCENA (COD 8)
NUME_FIRMA VARCHAR2(100) CONSTRAINT NN_NUMEF NOT NULL,
CAPACITATE NUMBER,
DESCRIERE VARCHAR2(100)
);

--INSERT PENTRU TERENURI
INSERT INTO TERENURI VALUES(
    1,
    'INTRARE',
    'INTRARE VIZITATORI',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(4,1, 9,4)
    )
);

INSERT INTO TERENURI VALUES(
    2,
    'ASFALT',
    'TEREN RECREERE SCENE 1 SI 2',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,1),
    SDO_ORDINATE_ARRAY(4,4, 16,4, 21,9, 21,12, 4,12, 4,4)
    )
);

INSERT INTO TERENURI VALUES(
    3,
    'PIETRIS',
    'ZONA SCENE 1 SI 2',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(4,12, 21,17)
    )
);

INSERT INTO TERENURI VALUES(
    4,
    'ASFALT',
    'ZONA TRANSFER SCENA 3',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,1),
    SDO_ORDINATE_ARRAY(4,17, 6,17, 13,22, 13,35, 10,35, 10,25, 4,22, 4,17)
    )
);

INSERT INTO TERENURI VALUES(
    5,
    'IARBA',
    'ZONA SCENA 3',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(4,32, 10,41)
    )
);

INSERT INTO TERENURI VALUES(
    6,
    'ASFALT',
    'TEREN RECREERE SCENA 3',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(10,35, 15,41)
    )
);

INSERT INTO TERENURI VALUES(
    7,
    'INTRARE',
    'INTRARE TRUPE',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(12,17, 15,19)
    )
);


INSERT INTO TERENURI VALUES(
    8,
    'IARBA',
    'ZONA CAMPING',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(25,18, 35,34)
    )
);

INSERT INTO TERENURI VALUES(
    9,
    'ASFALT',
    'PARCARE MASINI',
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(25,8, 35,18)
    )
);

SELECT * FROM TERENURI;

-- insert constructii
INSERT INTO CONSTRUCTII VALUES( -- birou informatii intrare
    1,
    1,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(8,2, 9,4)
    ),
    1
);

INSERT INTO CONSTRUCTII VALUES( -- mancare scene 1 si 2
    2,
    2,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,1),
    SDO_ORDINATE_ARRAY(15,5, 16,5, 20,9, 19,9, 15,5)
    ),
    2
);

INSERT INTO CONSTRUCTII VALUES( -- mancare transfer scene
    3,
    2,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(10,25, 11,30)
    ),
    4
);

INSERT INTO CONSTRUCTII VALUES( -- baruri scenele 1 si 2
    4,
    3,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(19,10, 21,12)
    ),
    2
);

INSERT INTO CONSTRUCTII VALUES( -- baruri pasaj scene
    5,
    3,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,1),
    SDO_ORDINATE_ARRAY(10,20, 13,22, 12,23, 9,21, 10,20)
    ),
    4
);
 
INSERT INTO CONSTRUCTII VALUES( -- baruri scena 3
    6,
    3,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(10,40, 14,41)
    ),
    5
);

INSERT INTO CONSTRUCTII VALUES( --prim ajutor
    7,
    4,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(18,15, 20,17)
    ),
    3
);


INSERT INTO CONSTRUCTII VALUES( -- merch trupe scene 1 si 2
    8,
    5,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(10,4, 14,5)
    ),
    2
);

INSERT INTO CONSTRUCTII VALUES( -- merch trupe transfer scene
    9,
    5,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,1),
    SDO_ORDINATE_ARRAY(7,18, 10,20, 9,21, 6,19, 7,18)
    ),
    4
);

INSERT INTO CONSTRUCTII VALUES( -- toalete scene 1 si 2
    10,
    6,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(4,7, 6,10)
    ),
    2
);

INSERT INTO CONSTRUCTII VALUES( -- toalete scena 3
    11,
    6,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(13,35, 15,36)
    ),
    6
);

INSERT INTO CONSTRUCTII VALUES( -- mese scene 1 si 2
    12,
    7,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,1),
    SDO_ORDINATE_ARRAY(12,7, 14,7, 18,11, 16,11, 12,7)
    ),
    2
);

INSERT INTO CONSTRUCTII VALUES( -- mese pasaj
    13,
    7,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,1),
    SDO_ORDINATE_ARRAY(5,21, 11,24, 10,25, 4,22, 5,21)
    ),
    4
);

INSERT INTO CONSTRUCTII VALUES( -- mese teren 3
    14,
    7,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(4,37, 6,41)
    ),
    5
);

INSERT INTO CONSTRUCTII VALUES( -- scena 1
    15,
    8,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(7,14, 12,17)
    ),
    3
);

INSERT INTO CONSTRUCTII VALUES( -- scena 2
    16,
    8,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(12,14, 17,17)
    ),
    3
);

INSERT INTO CONSTRUCTII VALUES( -- scena 3
    17,
    8,
    SDO_GEOMETRY(
    2003,
    NULL,
    NULL,
    SDO_ELEM_INFO_ARRAY(1,1003,3),
    SDO_ORDINATE_ARRAY(5,32, 10,34)
    ),
    5
);

--insert pentru info_constructii
INSERT INTO INFO_CONSTRUCTII VALUES (1, 'BIROU INFORMATII', 'Cranga Ana-Teea', 4, 'Biroul de informatii de la intrare');
INSERT INTO INFO_CONSTRUCTII VALUES (2, 'CORT MANCARE', 'Bucate pe Roate', 10, 'Cortul de mancare de la scenele 1 si 2');
INSERT INTO INFO_CONSTRUCTII VALUES (3, 'CORT MANCARE', 'Bucate pe Roate', 10, 'Cortul de mancare de la scena 3');
INSERT INTO INFO_CONSTRUCTII VALUES (4, 'BAR', 'Barock', 6, 'Barul de la scenele 1 si 2');
INSERT INTO INFO_CONSTRUCTII VALUES (5, 'BAR', 'Bariton', 6, 'Barul de la pasajul intre scene');
INSERT INTO INFO_CONSTRUCTII VALUES (6, 'BAR', 'Rockstadt SRL', 4, 'Barul de la scena 3');
INSERT INTO INFO_CONSTRUCTII VALUES (7, 'PRIM AJUTOR', 'Medicare', 8, 'Centru prim ajutor, scenele 1 si 2');
INSERT INTO INFO_CONSTRUCTII VALUES (8, 'CORT MERCH', 'Stage Tech', 10, 'Cort de merch trupe scenele 1 si 2');
INSERT INTO INFO_CONSTRUCTII VALUES (9, 'CORT MERCH', 'Stage Tech', 8, 'Cort de merch trupe scena 3');
INSERT INTO INFO_CONSTRUCTII VALUES (10, 'TOALETA', 'Clean Expert SRL', 6, 'Toaleta scenele 1 si 2');
INSERT INTO INFO_CONSTRUCTII VALUES (11, 'TOALETA', 'Clean Expert SRL', 6, 'Toaleta scena 3');
INSERT INTO INFO_CONSTRUCTII VALUES (12, 'ZONA MESE', 'Stage Tech', 150, 'Zona mese scenele 1 si 2');
INSERT INTO INFO_CONSTRUCTII VALUES (13, 'ZONA MESE', 'Stage Tech', 150, 'Zona mese pasajul intre scene');
INSERT INTO INFO_CONSTRUCTII VALUES (14, 'ZONA MESE', 'Stage Tech', 90, 'Zona mese scena 3');
INSERT INTO INFO_CONSTRUCTII VALUES (15, 'SCENA', 'Stage Tech', 20, 'Scena 1');
INSERT INTO INFO_CONSTRUCTII VALUES (16, 'SCENA', 'Stage Tech', 20, 'Scena 2');
INSERT INTO INFO_CONSTRUCTII VALUES (17, 'SCENA', 'Stage Tech', 20, 'Scena 3');

SELECT * FROM INFO_CONSTRUCTII;
-- viziunile standard de metadate
INSERT INTO user_sdo_geom_metadata
    (TABLE_NAME,
     COLUMN_NAME,
     DIMINFO,
     SRID)
  VALUES (
  'terenuri',
  'forma_teren',
  SDO_DIM_ARRAY(   
    SDO_DIM_ELEMENT('X', 0, 50, 0.005),
    SDO_DIM_ELEMENT('Y', 0, 50, 0.005)
     ),
  4326  
);

INSERT INTO user_sdo_geom_metadata
    (TABLE_NAME,
     COLUMN_NAME,
     DIMINFO,
     SRID)
  VALUES (
  'constructii',
  'forma_constructie',
  SDO_DIM_ARRAY(   
    SDO_DIM_ELEMENT('X', 0, 50, 0.005),
    SDO_DIM_ELEMENT('Y', 0, 50, 0.005)
     ),
  4326  
);

SELECT * FROM USER_SDO_GEOM_METADATA;

--indecsii spatiali
CREATE INDEX IDX_TERENURI ON TERENURI(FORMA_TEREN)
INDEXTYPE IS MDSYS.SPATIAL_INDEX;

CREATE INDEX IDX_CONSTRUCTII ON CONSTRUCTII(FORMA_CONSTRUCTIE)
INDEXTYPE IS MDSYS.SPATIAL_INDEX;


--Vizualizarea datelor spaţiale în Map View, sub diverse criteri
/*
    1. Sa se afiseze in Map View constructiile situate pe terenul 4 
*/
SELECT * FROM CONSTRUCTII 
WHERE ID_TEREN = 4;
    
/*
   2. Sa se afiseze in Map View constructiile care au capacitatea mai mare de 10 persoane 
    si sunt pe terenurile 2 si 3
*/
SELECT C.ID_CONSTRUCTIE, C.FORMA_CONSTRUCTIE, CAPACITATE FROM CONSTRUCTII C 
JOIN INFO_CONSTRUCTII I ON I.ID_CONSTRUCTIE = C.ID_CONSTRUCTIE
WHERE (ID_TEREN = 2 OR ID_TEREN = 3) AND CAPACITATE > 10;

/*
    3. Sa se calculeze distanta de la scene la cea mai apropiata baie. (distanta e raportata 1:5m)
*/
SET SERVEROUTPUT ON;
DECLARE
    CURSOR C IS SELECT ID_CONSTRUCTIE, DESCRIERE FROM INFO_CONSTRUCTII WHERE TIP_CONSTRUCTIE = 'SCENA';
    REZULTAT NUMBER; 
BEGIN
    FOR I IN C LOOP
        SELECT 5 * ROUND(MIN(SDO_GEOM.SDO_DISTANCE(C1.FORMA_CONSTRUCTIE, C2.FORMA_CONSTRUCTIE, 0.005))) INTO REZULTAT
        FROM CONSTRUCTII C1, CONSTRUCTII C2
        WHERE C2.ID_CONSTRUCTIE = I.ID_CONSTRUCTIE
        AND C1.ID_CONSTRUCTIE IN(SELECT ID_CONSTRUCTIE FROM INFO_CONSTRUCTII WHERE TIP_CONSTRUCTIE = 'TOALETA');
        DBMS_OUTPUT.PUT_LINE('DISTANTA DINTRE '|| I.DESCRIERE || ' SI CEA MAI APROPIATA TOALETA ESTE ' || REZULTAT || 'M');
    END LOOP;
END;
/

-- WIP PART
/*
    4. Sa se calculeze cat % din aria festivalului este ocupata de constructii. Terenurile 8 si 9 nu sunt incluse
*/

/*
    5. Sa se creeze un trigger care nu permite amplasarea cladirilor de tip CORT MANCARE, BAR, CORT MERCH pe teren de tip PIETRIS.
*/

